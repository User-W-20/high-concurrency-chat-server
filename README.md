# C++ 高并发模块化聊天室 (LiteChat)

## 📖 **项目简介**

LiteChat 是一个基于 **C++** 的多人聊天室项目，旨在通过实践深入理解现代操作系统中的 **高并发网络编程、多线程模型** 以及 **C++/脚本语言集成**。

* **服务器端采用 epoll + 线程池** 架构，能够高效处理大量并发客户端连接
* **模块化设计**，核心逻辑与功能模块解耦，支持通过 **Lua 脚本** 实现动态功能扩展

---

## ✨ **功能特点**

### 💻 **架构设计**
* **模块化管理**：服务器核心逻辑与群组功能独立，通过 `GroupManager` 管理群组
* **高可扩展性**：支持 Lua 脚本扩展，业务逻辑与核心 C++ 性能代码解耦，实现动态命令热加载
* **高并发网络模型**：基于 epoll 统一监听所有客户端事件，高效处理并发连接
* **线程池支持**：预创建工作线程，避免频繁创建/销毁线程，将 I/O 事件和耗时任务分离

### 👤 **用户与连接管理**
* **昵称系统**：首次连接需设置唯一昵称，自动检测冲突
* **心跳检测**：超过 60 秒未活动的客户端将被断开并回收资源

### 🗣 **核心功能**
* **广播消息**：公共消息带昵称并广播给所有在线用户
* **群组聊天**：支持用户创建、加入群组，群内消息隔离
* **私聊功能**：`/w <昵称> <消息>` 点对点私密通信
* **自定义命令 (NEW)**：支持客户端执行 Lua 脚本中定义的命令，例如 `/roll`

### 🛡 **管理员模式**
* **身份验证**：管理员通过一次性口令（默认 `admin123`）验证身份
* **踢人功能**：`/kick <昵称>` 踢出指定用户

---

## 📋 **命令支持**

| **命令** | **描述** | **权限** |
| ------- | ------- | ------ |
| `/hello` | Lua 脚本示例命令，测试脚本功能 | 所有用户 |
| `/list` | 查看当前所有在线用户 | 所有用户 |
| `/list_groups` | 查看所有已创建的群组 | 所有用户 |
| `/create <群名>` | 创建新群组并自动加入 | 所有用户 |
| `/join <群名>` | 加入指定群组 | 所有用户 |
| `/send <群名> <消息>` | 向群组内发送消息 | 群组成员 |
| `/w <昵称> <消息>` 或 `/whisper <昵称> <消息>` | 发送私聊消息 | 所有用户 |
| `/kick <昵称>` | 踢出用户 | 管理员 |
| `/quit` | 退出聊天室 | 所有用户 |
| `/roll [最大值]` | Lua 脚本命令，掷骰子 | 所有用户 |

---

## 🚀 **使用方法**

### 🔨 **构建项目**
为了支持 Lua 功能，你需要确保系统安装了 Lua 开发库 (`lua-devel`)。

```bash
# 假设系统已安装 Lua 库
mkdir build && cd build
cmake ..
make


## ▶️ 启动服务端

```bash
cd build/src
./server
````

日志示例：

```
[Lua] commands.lua 已加载
[Lua] Loaded command:   lua_cmd_roll
[Lua] Loaded command:   lua_cmd_hello
[INFO]Lua 虚拟机初始化成功，并成功加载 commands.lua。
[INFO]Lua 命令系统加载成功。
[INFO]服务器启动，等待客户端连接...
管理员口令已生成: admin123
```

---

## 💻 启动客户端

```bash
cd build/src
./client 127.0.0.1 12345
```

输入昵称即可加入聊天室。

---

## 💬 示例交互

客户端输入：

```
alice
/hello
/roll
```

服务端日志：

```
alice 加入聊天室
handle_message: fd=5, nickname=alice, is_admin=0, msg=/hello
[Lua] 执行 lua_cmd_hello
handle_message: fd=5, nickname=alice, is_admin=0, msg=/roll
[Lua] 执行 lua_cmd_roll
```

---

## 📝 TODO / 改进方向

* 增加更多 Lua 命令（如 `/kick`、`/mute` 等）
* 增加命令权限控制（仅管理员可执行某些命令）
* 使用 JSON/Protobuf 优化消息格式
* 日志系统分级输出到文件

```
```
